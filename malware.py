# scapy 패키지 import
from scapy.all import *

# Pcap 파일 읽기
def pcap_read(filiepath):
    packets = rdpcap(filiepath)
    data = dict()
    detect = dict()
    suspect = dict()
    data['total_pks'] = len(packets)
    try :
        # filename 추출
        for packet in packets:
            filename = None
            if packet.haslayer(Raw):
                raw = packet[Raw].load
                if b"filename=" in raw:
                    pos = raw.split(b"filename=")[1].split(b"&")[0]
                    filename = pos.split(b"\r")[0]
                    detect[filename] = ''
                    if b"MZ" in pos.split(b" GMT\r\n\r")[1]:
                        magic_number = pos.split(b" GMT\r\n\r")[1].split(b'\x90')[0]
                        detect[filename] = magic_number
                    else:
                        del detect[filename]
                        suspect[filename] = ''

    except Exception as err:
        print(err)
    finally:
        del detect[filename]
        suspect[filename] = ''
        print("finally")
        print(f"detect: {detect}")
        print(f"suspect: {suspect}")

        data['detect'] = detect
        data['suspect'] = suspect

        return data


if __name__ == '__main__':
    filiepath = 'exercise.pcap'
    print(pcap_read(filiepath))
